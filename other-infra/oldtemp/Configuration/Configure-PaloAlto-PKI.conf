# Palo Alto Firewall PKI Configuration
# Configure-PaloAlto-PKI.conf

# ============================================
# Palo Alto PAN-OS PKI Configuration
# ============================================

# 1. Import CA certificates
request certificate fetch ca-certificate name "CompanyRootCA" url "http://pki.company.com/CompanyRootCA.crt"
request certificate fetch ca-certificate name "CompanyIssuingCA01" url "http://pki.company.com/IssuingCA01.crt"
request certificate fetch ca-certificate name "CompanyIssuingCA02" url "http://pki.company.com/IssuingCA02.crt"

# 2. Configure certificate profile for validation
configure
set shared certificate-profile Company-Cert-Profile
set shared certificate-profile Company-Cert-Profile CA CompanyRootCA
set shared certificate-profile Company-Cert-Profile CA CompanyIssuingCA01
set shared certificate-profile Company-Cert-Profile CA CompanyIssuingCA02
set shared certificate-profile Company-Cert-Profile ocsp-url "http://ocsp.company.com/ocsp"
set shared certificate-profile Company-Cert-Profile crl-receive-timeout 5
set shared certificate-profile Company-Cert-Profile ocsp-receive-timeout 5
set shared certificate-profile Company-Cert-Profile block-unknown-cert yes
set shared certificate-profile Company-Cert-Profile block-timeout-cert yes
set shared certificate-profile Company-Cert-Profile block-expired-cert yes
set shared certificate-profile Company-Cert-Profile block-unauthenticated yes

# 3. Create SSL decryption profiles
set shared ssl-decryption ssl-forward-proxy Company-Forward-Proxy
set shared ssl-decryption ssl-forward-proxy Company-Forward-Proxy strip-alpn yes
set shared ssl-decryption ssl-forward-proxy Company-Forward-Proxy block-client-cert no
set shared ssl-decryption ssl-forward-proxy Company-Forward-Proxy block-expired-certificate yes
set shared ssl-decryption ssl-forward-proxy Company-Forward-Proxy block-untrusted-issuer yes
set shared ssl-decryption ssl-forward-proxy Company-Forward-Proxy block-unknown-cert yes
set shared ssl-decryption ssl-forward-proxy Company-Forward-Proxy block-unsupported-version yes
set shared ssl-decryption ssl-forward-proxy Company-Forward-Proxy block-unsupported-cipher yes

# 4. Create SSL inbound inspection profile
set shared ssl-decryption ssl-inbound-inspection Company-Inbound-Inspection
set shared ssl-decryption ssl-inbound-inspection Company-Inbound-Inspection block-if-no-resource yes
set shared ssl-decryption ssl-inbound-inspection Company-Inbound-Inspection block-unsupported-version yes
set shared ssl-decryption ssl-inbound-inspection Company-Inbound-Inspection block-unsupported-cipher yes

# 5. Configure SSL decryption policy rules

# Rule 1: No decrypt for PKI services
set rulebase decryption rules No-Decrypt-PKI
set rulebase decryption rules No-Decrypt-PKI from any
set rulebase decryption rules No-Decrypt-PKI to any
set rulebase decryption rules No-Decrypt-PKI source any
set rulebase decryption rules No-Decrypt-PKI destination [ ocsp.company.com crl.company.com pki.company.com ca.company.com ]
set rulebase decryption rules No-Decrypt-PKI service any
set rulebase decryption rules No-Decrypt-PKI application any
set rulebase decryption rules No-Decrypt-PKI action no-decrypt
set rulebase decryption rules No-Decrypt-PKI log-start yes
set rulebase decryption rules No-Decrypt-PKI log-end yes

# Rule 2: No decrypt for financial services
set rulebase decryption rules No-Decrypt-Financial
set rulebase decryption rules No-Decrypt-Financial from Trust-L3
set rulebase decryption rules No-Decrypt-Financial to Untrust-L3
set rulebase decryption rules No-Decrypt-Financial source any
set rulebase decryption rules No-Decrypt-Financial destination any
set rulebase decryption rules No-Decrypt-Financial service any
set rulebase decryption rules No-Decrypt-Financial url-category financial-services
set rulebase decryption rules No-Decrypt-Financial action no-decrypt
set rulebase decryption rules No-Decrypt-Financial log-start yes

# Rule 3: No decrypt for health services
set rulebase decryption rules No-Decrypt-Health
set rulebase decryption rules No-Decrypt-Health from Trust-L3
set rulebase decryption rules No-Decrypt-Health to Untrust-L3
set rulebase decryption rules No-Decrypt-Health source any
set rulebase decryption rules No-Decrypt-Health destination any
set rulebase decryption rules No-Decrypt-Health service any
set rulebase decryption rules No-Decrypt-Health url-category health-and-medicine
set rulebase decryption rules No-Decrypt-Health action no-decrypt
set rulebase decryption rules No-Decrypt-Health log-start yes

# Rule 4: SSL Forward Proxy for general traffic
set rulebase decryption rules SSL-Decrypt-Outbound
set rulebase decryption rules SSL-Decrypt-Outbound from Trust-L3
set rulebase decryption rules SSL-Decrypt-Outbound to Untrust-L3
set rulebase decryption rules SSL-Decrypt-Outbound source any
set rulebase decryption rules SSL-Decrypt-Outbound destination any
set rulebase decryption rules SSL-Decrypt-Outbound service any
set rulebase decryption rules SSL-Decrypt-Outbound application any
set rulebase decryption rules SSL-Decrypt-Outbound decrypt-type ssl-forward-proxy
set rulebase decryption rules SSL-Decrypt-Outbound profile Company-Forward-Proxy
set rulebase decryption rules SSL-Decrypt-Outbound log-start yes
set rulebase decryption rules SSL-Decrypt-Outbound log-end yes

# Rule 5: SSL Inbound Inspection for DMZ servers
set rulebase decryption rules SSL-Decrypt-Inbound
set rulebase decryption rules SSL-Decrypt-Inbound from Untrust-L3
set rulebase decryption rules SSL-Decrypt-Inbound to DMZ-L3
set rulebase decryption rules SSL-Decrypt-Inbound source any
set rulebase decryption rules SSL-Decrypt-Inbound destination [ 10.20.1.100 10.20.1.101 10.20.1.102 ]
set rulebase decryption rules SSL-Decrypt-Inbound service any
set rulebase decryption rules SSL-Decrypt-Inbound application any
set rulebase decryption rules SSL-Decrypt-Inbound decrypt-type ssl-inbound-inspection
set rulebase decryption rules SSL-Decrypt-Inbound profile Company-Inbound-Inspection
set rulebase decryption rules SSL-Decrypt-Inbound log-start yes
set rulebase decryption rules SSL-Decrypt-Inbound log-end yes

# 6. Generate certificate for management interface
request certificate generate ca no algorithm RSA certificate-name "PA-FW-Mgmt-Cert" name "PA-FW-Mgmt-Cert" rsa-nbits 2048
request certificate generate signed-by external certificate-name "PA-FW-Mgmt-Cert" csr-file "PA-FW-Mgmt.csr" digest sha256 email "security@company.com" hostname "fw-mgmt.company.com" ip "10.20.3.10" organization "Company Inc" organization-unit "Network Security"

# 7. Configure OCSP responder settings
set deviceconfig system ocsp-responder CompanyOCSP
set deviceconfig system ocsp-responder CompanyOCSP url "http://ocsp.company.com/ocsp"
set deviceconfig system ocsp-responder CompanyOCSP certificate-profile Company-Cert-Profile

# 8. Enable certificate status monitoring
set deviceconfig system certificate-monitoring enabled yes
set deviceconfig system certificate-monitoring notification-email security@company.com
set deviceconfig system certificate-monitoring notification-email pki-team@company.com
set deviceconfig system certificate-monitoring expiry-threshold 30

# 9. Configure certificate for GlobalProtect portal
set global-protect global-protect-portal Portal-Config
set global-protect global-protect-portal Portal-Config portal-config certificate-profile Company-Cert-Profile
set global-protect global-protect-portal Portal-Config portal-config client-certificate-profile Company-Cert-Profile
set global-protect global-protect-portal Portal-Config portal-config ssl-tls-service-profile TLS-1.2-Only

# 10. Configure syslog for certificate events
set shared log-settings syslog PKI-Events
set shared log-settings syslog PKI-Events server PKI-Syslog-Server
set shared log-settings syslog PKI-Events server PKI-Syslog-Server server "10.50.1.50"
set shared log-settings syslog PKI-Events server PKI-Syslog-Server transport UDP
set shared log-settings syslog PKI-Events server PKI-Syslog-Server port 514
set shared log-settings syslog PKI-Events server PKI-Syslog-Server format BSD
set shared log-settings syslog PKI-Events server PKI-Syslog-Server facility LOG_LOCAL3

# 11. Configure log forwarding for certificate events
set shared log-settings profiles PKI-Log-Profile
set shared log-settings profiles PKI-Log-Profile match-list PKI-Certificate-Events
set shared log-settings profiles PKI-Log-Profile match-list PKI-Certificate-Events send-syslog PKI-Events
set shared log-settings profiles PKI-Log-Profile match-list PKI-Certificate-Events log-type decryption
set shared log-settings profiles PKI-Log-Profile match-list PKI-Certificate-Events filter "( action eq allow ) or ( action eq deny ) or ( action eq decrypt ) or ( action eq no-decrypt )"
set shared log-settings profiles PKI-Log-Profile match-list PKI-Certificate-Events send-to-panorama yes

# 12. Configure custom URL categories for certificate services
set shared custom-url-category Company-PKI-Services
set shared custom-url-category Company-PKI-Services list [ pki.company.com ocsp.company.com crl.company.com ca.company.com ]
set shared custom-url-category Company-PKI-Services description "Company PKI Infrastructure URLs"

# 13. Create security policy for PKI services
set rulebase security rules Allow-PKI-Services
set rulebase security rules Allow-PKI-Services from any
set rulebase security rules Allow-PKI-Services to any
set rulebase security rules Allow-PKI-Services source any
set rulebase security rules Allow-PKI-Services destination any
set rulebase security rules Allow-PKI-Services application [ ocsp ssl web-browsing ]
set rulebase security rules Allow-PKI-Services service [ service-http service-https ]
set rulebase security rules Allow-PKI-Services category Company-PKI-Services
set rulebase security rules Allow-PKI-Services action allow
set rulebase security rules Allow-PKI-Services log-start yes
set rulebase security rules Allow-PKI-Services log-end yes
set rulebase security rules Allow-PKI-Services profile-setting profiles virus-and-wildfire-analysis default
set rulebase security rules Allow-PKI-Services profile-setting profiles spyware strict
set rulebase security rules Allow-PKI-Services profile-setting profiles vulnerability strict
set rulebase security rules Allow-PKI-Services profile-setting profiles url-filtering default

# 14. Configure certificate-based authentication for administrators
set mgt-config users admin-user
set mgt-config users admin-user authentication-profile Certificate-Auth-Profile
set mgt-config users admin-user client-certificate-only yes
set mgt-config users admin-user permissions role-based superuser yes

# 15. Commit configuration
commit description "PKI Integration - Complete Certificate Management Configuration"

# End of configuration